import { describe, it, expect, beforeEach, afterEach } from 'vitest';
import { {{componentNamePascal}} } from './index';

{{componentNamePascal}}.define();

function html(strings: TemplateStringsArray, ...values: unknown[]): string {
  return strings.reduce((result, str, i) => result + str + (values[i] || ''), '');
}

async function fixture<T extends HTMLElement>(template: string): Promise<T> {
  const container = document.createElement('div');
  container.innerHTML = template;
  const element = container.firstElementChild as T;
  document.body.appendChild(element);
  await new Promise(resolve => setTimeout(resolve, 0));
  return element;
}

async function waitUntil(condition: () => boolean, timeout = 5000): Promise<void> {
  const start = Date.now();
  while (!condition()) {
    if (Date.now() - start > timeout) {
      throw new Error('waitUntil timeout');
    }
    await new Promise(resolve => setTimeout(resolve, 10));
  }
}

beforeEach(() => {
  document.body.innerHTML = '';
});

afterEach(() => {
  document.body.innerHTML = '';
});

describe('{{componentName}}', () => {
  describe('basic rendering', () => {
    it('should render', async () => {
      const el = await fixture<{{componentNamePascal}}>(html`
        <{{componentName}} example="test">
          Test content
        </{{componentName}}>
      `);

      expect(el).toBeInstanceOf({{componentNamePascal}});
      expect(el.example).toBe('test');
    });

    it('should have default example', async () => {
      const el = await fixture<{{componentNamePascal}}>(html`
        <{{componentName}}>Test</{{componentName}}>
      `);

      expect(el.example).toBe('');
    });
  });

  describe('attributes', () => {
    it('should reflect example attribute', async () => {
      const el = await fixture<{{componentNamePascal}}>(html`
        <{{componentName}} example="initial">Test</{{componentName}}>
      `);

      expect(el.example).toBe('initial');
      expect(el.getAttribute('example')).toBe('initial');

      el.example = 'updated';
      await new Promise(resolve => setTimeout(resolve, 0));

      expect(el.getAttribute('example')).toBe('updated');
    });
  });

{{#if hasEvents}}
  describe('events', () => {
    it('should dispatch {{componentName}}-change event', async () => {
      const el = await fixture<{{componentNamePascal}}>(html`
        <{{componentName}} example="initial">Test</{{componentName}}>
      `);

      let eventFired = false;
      let eventDetail: any;

      el.addEventListener('{{componentName}}-change', (e: Event) => {
        eventFired = true;
        eventDetail = (e as CustomEvent).detail;
      });

      el.example = 'changed';
      await new Promise(resolve => setTimeout(resolve, 0));

      expect(eventFired).toBe(true);
      expect(eventDetail.example).toBe('changed');
    });

    it('should dispatch standard change event', async () => {
      const el = await fixture<{{componentNamePascal}}>(html`
        <{{componentName}} example="initial">Test</{{componentName}}>
      `);

      let changeEventFired = false;

      el.addEventListener('change', () => {
        changeEventFired = true;
      });

      el.example = 'changed';
      await new Promise(resolve => setTimeout(resolve, 0));

      expect(changeEventFired).toBe(true);
    });
  });
{{/if}}
});
